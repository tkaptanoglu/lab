---
# playbooks/golden_image/security_baselines.yml
# Purpose: Fully remove Falco if present, reinstall Falco with classic eBPF on Ubuntu 22.04 (Raspberry Pi),
#          install/compile the eBPF probe via falcoctl, and update Falco rules.

- name: Install security baselines
  hosts: all
  become: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3

  roles:
    - role: roles/security/ids/falco/installation
      vars:
        falco_reinstall_if_present: false
        falco_purge_on_remove: true

        # eBPF-only install path (final working approach on ubuntu-raspi)
        falco_driver_choice: "ebpf"
        falco_install_ebpf_build_deps: true

        # Update rules via falcoctl artifact
        falco_update_rules: true
        falco_rules_artifact: "falco-rules"
        falco_rules_tag: "latest"

        # Services
        falco_service_enabled: true
        falco_service_state: started

        # Optional: background artifact updates (off by default)
        falco_enable_artifact_follow: false
    - role: roles/security/ids/falco/email_alerts_setup
    - role: roles/security/patching
      vars:
        server_autopatch_origins:
          - "o=Ubuntu,a=${distro_codename}-security"
          - "o=Ubuntu,a=${distro_codename}-updates"

