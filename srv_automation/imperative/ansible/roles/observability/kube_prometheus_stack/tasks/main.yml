---
- name: Ensure Grafana admin password is provided (from Vault)
  ansible.builtin.assert:
    that:
      - kps_grafana_admin_password is defined
      - (kps_grafana_admin_password | string | length) > 0
    fail_msg: >
      kps_grafana_admin_password is not set. Put vault_grafana_admin_password in inventory/group_vars/all/vault.yml
      and map it in inventory/group_vars/all/main.yml.

- name: Verify kubeconfig exists on the master we are running Helm from
  ansible.builtin.stat:
    path: "{{ kps_kubeconfig_path }}"
  register: kps_kubeconfig

- name: Fail if kubeconfig is missing
  ansible.builtin.fail:
    msg: "kubeconfig not found at {{ kps_kubeconfig_path }} on {{ inventory_hostname }}. Helm needs cluster access."
  when: not kps_kubeconfig.stat.exists

# Preflight checks that are compatible with older kubectl versions
- name: Preflight - show kubectl client version
  ansible.builtin.command:
    cmd: kubectl version --client=true
  register: kubectl_client_version
  changed_when: false
  environment:
    KUBECONFIG: "{{ kps_kubeconfig_path }}"

- name: Preflight - confirm kubectl can reach the Kubernetes API
  ansible.builtin.command:
    cmd: kubectl get --raw=/version
  register: kubectl_server_version
  changed_when: false
  environment:
    KUBECONFIG: "{{ kps_kubeconfig_path }}"

- name: Add prometheus-community Helm repo
  ansible.builtin.command:
    cmd: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
  register: helm_repo_add
  changed_when: "'has been added' in helm_repo_add.stdout or 'updated' in helm_repo_add.stdout"

- name: Helm repo update
  ansible.builtin.command:
    cmd: helm repo update
  changed_when: false

- name: Render kube-prometheus-stack values file
  ansible.builtin.template:
    src: values.yaml.j2
    dest: "/tmp/{{ kps_release_name }}-values.yaml"
    mode: "0644"

- name: Install/upgrade kube-prometheus-stack
  ansible.builtin.command:
    cmd: >-
      helm upgrade --install {{ kps_release_name }} {{ kps_chart_ref }}
      --namespace {{ kps_namespace }}
      --create-namespace
      -f /tmp/{{ kps_release_name }}-values.yaml
      {% if kps_chart_version | length > 0 %} --version {{ kps_chart_version }} {% endif %}
      --wait
      --timeout 15m
  register: helm_apply
  changed_when: >
    ('has been upgraded' in helm_apply.stdout) or
    ('has been installed' in helm_apply.stdout) or
    ('installed' in helm_apply.stdout)
  environment:
    KUBECONFIG: "{{ kps_kubeconfig_path }}"

- name: Get Grafana service name
  ansible.builtin.command:
    cmd: kubectl -n {{ kps_namespace }} get svc -l "app.kubernetes.io/name=grafana" -o jsonpath="{.items[0].metadata.name}"
  register: grafana_svc_name
  changed_when: false
  environment:
    KUBECONFIG: "{{ kps_kubeconfig_path }}"

- name: Get Grafana NodePort (if NodePort)
  ansible.builtin.command:
    cmd: kubectl -n {{ kps_namespace }} get svc {{ grafana_svc_name.stdout }} -o jsonpath="{.spec.ports[0].nodePort}"
  register: grafana_nodeport_actual
  changed_when: false
  when: kps_grafana_service_type == "NodePort"
  environment:
    KUBECONFIG: "{{ kps_kubeconfig_path }}"

- name: Show Grafana URL (NodePort)
  ansible.builtin.debug:
    msg:
      - "Grafana URL: http://{{ ansible_host }}:{{ grafana_nodeport_actual.stdout }}"
      - "Username: admin"
      - "Password: (from Ansible Vault: vault_grafana_admin_password)"
  when: kps_grafana_service_type == "NodePort"

