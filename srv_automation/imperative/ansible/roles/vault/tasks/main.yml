---
# roles/vault/tasks/main.yml
# Complete Vault install flow for Ubuntu ARM64 (aarch64)
# Installs Vault from HashiCorp release zip (no apt package), writes config + systemd unit, starts service.

############################################################
# 0. Optional cleanup: remove HashiCorp APT repo list
############################################################
- name: Remove HashiCorp repo list file if requested
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/hashicorp.list"
    state: absent
  when: vault_remove_hashicorp_repo | default(false)

############################################################
# 1. Derive install directory (no ternary / no comparisons)
############################################################
- name: Derive Vault install dir from vault_bin_path (fallback)
  ansible.builtin.set_fact:
    vault_install_dir_effective: "{{ vault_install_dir | default((vault_bin_path | dirname), true) }}"

- name: Assert required variables are present
  ansible.builtin.assert:
    that:
      - vault_version is defined
      - vault_bin_path is defined
      - vault_config_dir is defined
      - vault_data_dir is defined
      - vault_log_dir is defined
      - vault_service_name is defined
      - vault_systemd_unit_path is defined
      - vault_user is defined
      - vault_group is defined
    fail_msg: "One or more required Vault role variables are missing. Check defaults/main.yml."

############################################################
# 2. Prerequisites for download/unzip
############################################################
- name: Install required packages (curl, unzip, ca-certificates)
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - unzip
    state: present
    update_cache: true

############################################################
# 3. Ensure vault user/group + directories
############################################################
- name: Ensure Vault group exists
  ansible.builtin.group:
    name: "{{ vault_group }}"
    system: yes

- name: Ensure Vault user exists
  ansible.builtin.user:
    name: "{{ vault_user }}"
    group: "{{ vault_group }}"
    shell: /usr/sbin/nologin
    system: yes
    create_home: no

- name: Create Vault directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ vault_config_dir }}", owner: "root",            group: "{{ vault_group }}", mode: "0750" }
    - { path: "{{ vault_data_dir }}",   owner: "{{ vault_user }}", group: "{{ vault_group }}", mode: "0750" }
    - { path: "{{ vault_log_dir }}",    owner: "{{ vault_user }}", group: "{{ vault_group }}", mode: "0750" }

############################################################
# 4. Download + verify Vault release and checksum
############################################################
- name: Set Vault download URLs (ARM64)
  ansible.builtin.set_fact:
    vault_zip_filename: "vault_{{ vault_version }}_linux_arm64.zip"
    vault_zip_url: "https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ vault_version }}_linux_arm64.zip"
    vault_sha_url: "https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ vault_version }}_SHA256SUMS"
    vault_sha_file: "/tmp/vault_{{ vault_version }}_SHA256SUMS"
    vault_zip_path: "/tmp/vault_{{ vault_version }}_linux_arm64.zip"

- name: Download Vault SHA256SUMS
  ansible.builtin.get_url:
    url: "{{ vault_sha_url }}"
    dest: "{{ vault_sha_file }}"
    mode: "0644"
    force: yes

- name: Extract expected sha256 for arm64 zip
  ansible.builtin.shell: |
    set -euo pipefail
    grep -E " {{ vault_zip_filename | regex_escape() }}$" "{{ vault_sha_file }}" | awk '{print $1}'
  args:
    executable: /bin/bash
  register: vault_sha_value
  changed_when: false

- name: Assert we found a checksum entry for the arm64 zip
  ansible.builtin.assert:
    that:
      - vault_sha_value.stdout is match("^[a-f0-9]{64}$")
    fail_msg: "Could not extract a valid SHA256 for {{ vault_zip_filename }} from {{ vault_sha_file }}."

- name: Download Vault zip (with checksum verification)
  ansible.builtin.get_url:
    url: "{{ vault_zip_url }}"
    dest: "{{ vault_zip_path }}"
    checksum: "sha256:{{ vault_sha_value.stdout }}"
    mode: "0644"
    force: yes

############################################################
# 5. Install Vault binary
############################################################
- name: Ensure Vault bin dir exists
  ansible.builtin.file:
    path: "{{ vault_install_dir_effective }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Unarchive Vault binary to bin dir
  ansible.builtin.unarchive:
    src: "{{ vault_zip_path }}"
    dest: "{{ vault_install_dir_effective }}"
    remote_src: yes
    owner: root
    group: root
    mode: "0755"

- name: Ensure Vault binary permissions
  ansible.builtin.file:
    path: "{{ vault_bin_path }}"
    owner: root
    group: root
    mode: "0755"

############################################################
# 6. Install Vault config (HCL)
############################################################
- name: Install Vault config
  ansible.builtin.template:
    src: vault.hcl.j2
    dest: "{{ vault_config_dir }}/vault.hcl"
    owner: root
    group: "{{ vault_group }}"
    mode: "0640"
  notify: restart vault

############################################################
# 7. Install Vault systemd service
############################################################
- name: Install Vault systemd unit
  ansible.builtin.template:
    src: vault.service.j2
    dest: "{{ vault_systemd_unit_path }}"
    owner: root
    group: root
    mode: "0644"

- name: Reload systemd
  ansible.builtin.systemd:
    daemon_reload: true

############################################################
# 8. Enable + start Vault
############################################################
- name: Enable and start Vault
  ansible.builtin.systemd:
    name: "{{ vault_service_name }}"
    enabled: true
    state: started

