---
# Use admin.conf explicitly so kubernetes.core doesn't try ~/.kube/config
# Also run as root so admin.conf is readable.

- name: Apply Flannel manifest (prefer kubernetes.core.k8s)
  block:
    - name: Apply Flannel manifest via k8s module
      kubernetes.core.k8s:
        kubeconfig: "/etc/kubernetes/admin.conf"
        state: present
        src: "{{ flannel_manifest_url }}"
      become: true

    - name: Wait for Flannel DaemonSet to be ready (k8s_info)
      kubernetes.core.k8s_info:
        kubeconfig: "/etc/kubernetes/admin.conf"
        api_version: apps/v1
        kind: DaemonSet
        name: "{{ flannel_daemonset_name }}"
        namespace: "{{ flannel_namespace }}"
      become: true
      register: flannel_ds
      until: >
        flannel_ds.resources | length > 0 and
        (flannel_ds.resources[0].status.numberReady | default(0)) | int ==
        (flannel_ds.resources[0].status.desiredNumberScheduled | default(0)) | int and
        (flannel_ds.resources[0].status.desiredNumberScheduled | default(0)) | int > 0
      retries: "{{ flannel_wait_retries }}"
      delay: "{{ flannel_wait_delay }}"

  rescue:
    # If the python client / module still has issues, fall back to kubectl (your original behavior)
    - name: Fallback -- Apply Flannel manifest via kubectl
      ansible.builtin.command:
        cmd: "kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f {{ flannel_manifest_url }}"
      become: true
      register: flannel_apply_fallback
      changed_when: >
        ('created' in (flannel_apply_fallback.stdout | lower)) or
        ('configured' in (flannel_apply_fallback.stdout | lower))

    - name: Fallback -- Wait for Flannel DaemonSet readiness via kubectl
      ansible.builtin.command:
        cmd: >
          kubectl --kubeconfig=/etc/kubernetes/admin.conf -n {{ flannel_namespace }}
          get ds {{ flannel_daemonset_name }}
          -o jsonpath='{.status.numberReady} {.status.desiredNumberScheduled}'
      become: true
      register: flannel_ds_fallback
      changed_when: false
      until: >
        (flannel_ds_fallback.stdout.split(' ')[0] | int) ==
        (flannel_ds_fallback.stdout.split(' ')[1] | int) and
        (flannel_ds_fallback.stdout.split(' ')[1] | int) > 0
      retries: "{{ flannel_wait_retries }}"
      delay: "{{ flannel_wait_delay }}"

