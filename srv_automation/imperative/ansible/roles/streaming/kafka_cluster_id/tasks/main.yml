---
# Guarantees kafka_cluster_id_effective is available to later roles.
# Persists cluster id ON THE BROKER(S): {{ kafka_data_dir }}/cluster.id
#
# Priority:
# 1) real kafka_cluster_id from inventory (NOT placeholder)
# 2) broker file {{ kafka_data_dir }}/cluster.id
# 3) generate once on first broker, distribute, then persist
#
# This role must work BEFORE kafka user/group exist.

- name: HARD DEBUG – show raw kafka_cluster_id from all sources
  ansible.builtin.debug:
    var: kafka_cluster_id

# ------------------------------------------------------------
# STEP 0 — detect kafka user and group (may not exist yet)
# ------------------------------------------------------------

- name: Check whether kafka user exists yet
  ansible.builtin.getent:
    database: passwd
    key: "{{ kafka_user | default('kafka') }}"
  register: kafka_user_getent
  failed_when: false
  changed_when: false

- name: Check whether kafka group exists yet
  ansible.builtin.getent:
    database: group
    key: "{{ kafka_group | default('kafka') }}"
  register: kafka_group_getent
  failed_when: false
  changed_when: false

- name: Set kafka_user_exists / kafka_group_exists
  ansible.builtin.set_fact:
    kafka_user_exists: "{{ (kafka_user_getent.ansible_facts.getent_passwd | default({})) | length > 0 }}"
    kafka_group_exists: "{{ (kafka_group_getent.ansible_facts.getent_group | default({})) | length > 0 }}"

# ------------------------------------------------------------
# STEP 1 — ensure data dir exists (safe user/group fallback)
# ------------------------------------------------------------

- name: Ensure kafka_data_dir exists
  ansible.builtin.file:
    path: "{{ kafka_data_dir }}"
    state: directory
    owner: "{{ kafka_user_exists | ternary((kafka_user | default('kafka')), 'root') }}"
    group: "{{ kafka_group_exists | ternary((kafka_group | default('kafka')), 'root') }}"
    mode: "0755"

# ------------------------------------------------------------
# STEP 2 — initialize effective ID
# ------------------------------------------------------------

- name: Initialize kafka_cluster_id_effective to empty
  ansible.builtin.set_fact:
    kafka_cluster_id_effective: ""

# ------------------------------------------------------------
# STEP 3 — inventory variable (REAL UUID ONLY)
# ------------------------------------------------------------

- name: Use real inventory kafka_cluster_id if provided
  ansible.builtin.set_fact:
    kafka_cluster_id_effective: "{{ kafka_cluster_id | string | trim }}"
  when:
    - kafka_cluster_id is defined
    - (kafka_cluster_id | string | trim | length) > 10
    - (kafka_cluster_id | string | trim) not in ['REPLACE_ME_WITH_A_REAL_UUID', 'CHANGE_ME', 'placeholder', 'PLACEHOLDER', '']

# ------------------------------------------------------------
# STEP 4 — broker-persisted cluster.id
# ------------------------------------------------------------

- name: Check for persisted cluster.id file
  ansible.builtin.stat:
    path: "{{ kafka_data_dir }}/cluster.id"
  register: kafka_cluster_id_file

- name: Read broker cluster.id
  ansible.builtin.slurp:
    path: "{{ kafka_data_dir }}/cluster.id"
  register: kafka_cluster_id_slurp
  when:
    - kafka_cluster_id_effective | length == 0
    - kafka_cluster_id_file.stat.exists

- name: Use broker cluster.id value
  ansible.builtin.set_fact:
    kafka_cluster_id_effective: "{{ kafka_cluster_id_slurp.content | b64decode | trim }}"
  when:
    - kafka_cluster_id_effective | length == 0
    - kafka_cluster_id_slurp is defined
    - kafka_cluster_id_slurp.content is defined
    - (kafka_cluster_id_slurp.content | b64decode | trim | length) > 10
    - (kafka_cluster_id_slurp.content | b64decode | trim) not in ['REPLACE_ME_WITH_A_REAL_UUID', 'CHANGE_ME', 'placeholder', 'PLACEHOLDER', '']

# ------------------------------------------------------------
# STEP 5 — generate new cluster ID (run once, distribute)
# ------------------------------------------------------------

- name: Check if kafka-storage.sh exists on first broker
  ansible.builtin.stat:
    path: "{{ kafka_install_dir }}/bin/kafka-storage.sh"
  register: kafka_storage_sh
  run_once: true
  delegate_to: "{{ ansible_play_hosts[0] }}"
  when: kafka_cluster_id_effective | length == 0

- name: Generate cluster id on first broker (run once)
  ansible.builtin.command: >-
    {{ (kafka_storage_sh.stat.exists | default(false))
       | ternary(kafka_install_dir ~ '/bin/kafka-storage.sh random-uuid',
                'python3 -c "import uuid; print(uuid.uuid4())"') }}
  register: kafka_cluster_id_generated
  changed_when: false
  run_once: true
  delegate_to: "{{ ansible_play_hosts[0] }}"
  when: kafka_cluster_id_effective | length == 0

- name: Broadcast generated ID to all brokers
  ansible.builtin.set_fact:
    kafka_cluster_id_effective: "{{ hostvars[ansible_play_hosts[0]].kafka_cluster_id_generated.stdout | default('') | trim }}"
  when:
    - kafka_cluster_id_effective | length == 0
    - (hostvars[ansible_play_hosts[0]].kafka_cluster_id_generated.stdout | default('') | trim | length) > 10

# ------------------------------------------------------------
# STEP 6 — validation (must NOT be placeholder)
# ------------------------------------------------------------

- name: Assert final cluster id is valid
  ansible.builtin.assert:
    that:
      - (kafka_cluster_id_effective | string | trim | length) > 10
      - (kafka_cluster_id_effective | string | trim) not in ['REPLACE_ME_WITH_A_REAL_UUID', 'CHANGE_ME', 'placeholder', 'PLACEHOLDER', '']
    fail_msg: >
      kafka_cluster_id_effective is invalid or placeholder.

# ------------------------------------------------------------
# STEP 7 — persist cluster.id to disk (overwrite if it is placeholder)
# ------------------------------------------------------------

- name: Persist cluster id to broker disk
  ansible.builtin.copy:
    dest: "{{ kafka_data_dir }}/cluster.id"
    content: "{{ kafka_cluster_id_effective | trim }}\n"
    owner: "{{ kafka_user_exists | ternary((kafka_user | default('kafka')), 'root') }}"
    group: "{{ kafka_group_exists | ternary((kafka_group | default('kafka')), 'root') }}"
    mode: "0644"

# ------------------------------------------------------------
# STEP 8 — fix ownership after kafka user appears
# ------------------------------------------------------------

- name: Ensure kafka_data_dir ownership if kafka user/group exist
  ansible.builtin.file:
    path: "{{ kafka_data_dir }}"
    owner: "{{ kafka_user | default('kafka') }}"
    group: "{{ kafka_group | default('kafka') }}"
    state: directory
  when:
    - kafka_user_exists
    - kafka_group_exists

- name: Ensure cluster.id ownership if kafka user/group exist
  ansible.builtin.file:
    path: "{{ kafka_data_dir }}/cluster.id"
    owner: "{{ kafka_user | default('kafka') }}"
    group: "{{ kafka_group | default('kafka') }}"
  when:
    - kafka_user_exists
    - kafka_group_exists

# ------------------------------------------------------------
# STEP 9 — show result
# ------------------------------------------------------------

- name: Show final cluster id (once)
  ansible.builtin.debug:
    msg: "Using REAL KRaft cluster id: {{ kafka_cluster_id_effective }}"
  run_once: true
