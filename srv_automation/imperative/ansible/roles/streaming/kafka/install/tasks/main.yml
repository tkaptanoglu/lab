---
- name: Install required packages (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - curl
      - tar
      - gzip
      - bash
      - coreutils
      - openjdk-17-jre-headless
      - python3
    state: present
    update_cache: true
  when: ansible_facts.os_family == "Debian"

- name: Create kafka group
  ansible.builtin.group:
    name: "{{ kafka_group }}"
    system: true
    state: present

- name: Create kafka user
  ansible.builtin.user:
    name: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    system: true
    create_home: false
    shell: /usr/sbin/nologin
    state: present

- name: Create directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0755"
  loop:
    - "{{ kafka_install_dir }}"
    - "{{ kafka_data_dir }}"
    - "{{ kafka_log_dir }}"

- name: Define Kafka paths
  ansible.builtin.set_fact:
    kafka_tarball: "/tmp/kafka_{{ kafka_scala_version }}-{{ kafka_version }}.tgz"
    kafka_versioned_dir: "/opt/kafka_{{ kafka_scala_version }}-{{ kafka_version }}"

- name: Download Kafka tarball (prefer dlcdn, fallback to archive)
  block:
    - name: Download from dlcdn.apache.org
      ansible.builtin.get_url:
        url: "https://dlcdn.apache.org/kafka/{{ kafka_version }}/kafka_{{ kafka_scala_version }}-{{ kafka_version }}.tgz"
        dest: "{{ kafka_tarball }}"
        mode: "0644"
  rescue:
    - name: Download from archive.apache.org (fallback)
      ansible.builtin.get_url:
        url: "https://archive.apache.org/dist/kafka/{{ kafka_version }}/kafka_{{ kafka_scala_version }}-{{ kafka_version }}.tgz"
        dest: "{{ kafka_tarball }}"
        mode: "0644"

- name: Check whether Kafka appears extracted correctly
  ansible.builtin.stat:
    path: "{{ kafka_versioned_dir }}/bin/kafka-server-start.sh"
  register: kafka_extracted_ok

- name: Extract Kafka to /opt (versioned folder) if missing/invalid
  ansible.builtin.unarchive:
    src: "{{ kafka_tarball }}"
    dest: "/opt"
    remote_src: true
  when: not kafka_extracted_ok.stat.exists

# ---- HARD CLEANUP: remove all other kafka_* installs (prevents interference)
- name: Find other Kafka installs under /opt
  ansible.builtin.find:
    paths: /opt
    file_type: directory
    patterns: "kafka_*"
    use_regex: false
  register: kafka_opt_candidates
  when: kafka_cleanup_old_versions | default(true) | bool

- name: Remove other Kafka installs (keep only current versioned dir)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ kafka_opt_candidates.files | default([]) }}"
  when:
    - kafka_cleanup_old_versions | default(true) | bool
    - item.path != kafka_versioned_dir

# If /opt/kafka exists as a DIRECTORY (not symlink), delete it so we can link cleanly
- name: Check kafka_install_dir state
  ansible.builtin.stat:
    path: "{{ kafka_install_dir }}"
  register: kafka_install_dir_stat

- name: Remove kafka_install_dir if it is a directory (must be symlink)
  ansible.builtin.file:
    path: "{{ kafka_install_dir }}"
    state: absent
  when:
    - kafka_install_dir_stat.stat.exists
    - kafka_install_dir_stat.stat.islnk is not defined or not kafka_install_dir_stat.stat.islnk
    - kafka_install_dir_stat.stat.isdir | default(false)

- name: Symlink current kafka to kafka_install_dir
  ansible.builtin.file:
    src: "{{ kafka_versioned_dir }}"
    dest: "{{ kafka_install_dir }}"
    state: link
    force: true

- name: Ensure Kafka install ownership (versioned dir)
  ansible.builtin.file:
    path: "{{ kafka_versioned_dir }}"
    state: directory
    recurse: true
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"

- name: Ensure Kraft config directory exists (safety net)
  ansible.builtin.file:
    path: "{{ kafka_install_dir }}/config/kraft"
    state: directory
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0755"
