---
- name: Gather service facts
  ansible.builtin.service_facts:

- name: Assert kafka service is present
  ansible.builtin.assert:
    that:
      - "'kafka.service' in ansible_facts.services"
    fail_msg: "kafka.service is not present on this host."

- name: Assert kafka service is running
  ansible.builtin.assert:
    that:
      - ansible_facts.services['kafka.service'].state == 'running'
    fail_msg: "kafka.service is not running (state={{ ansible_facts.services['kafka.service'].state }})."

- name: Wait for Kafka client port on localhost
  ansible.builtin.wait_for:
    host: "127.0.0.1"
    port: "{{ kafka_client_port }}"
    timeout: "{{ kafka_verify_timeout_seconds }}"

- name: Verify Kafka responds locally (broker api versions)
  ansible.builtin.command: "{{ kafka_install_dir }}/bin/kafka-broker-api-versions.sh --bootstrap-server 127.0.0.1:{{ kafka_client_port }}"
  register: kafka_verify_broker_api_versions
  retries: "{{ kafka_verify_retries }}"
  delay: "{{ kafka_verify_delay_seconds }}"
  until: kafka_verify_broker_api_versions.rc == 0

- name: Show broker api versions output
  ansible.builtin.debug:
    var: kafka_verify_broker_api_versions.stdout_lines

- name: Check metadata quorum status (KRaft)
  ansible.builtin.command: "{{ kafka_install_dir }}/bin/kafka-metadata-quorum.sh --bootstrap-server 127.0.0.1:{{ kafka_client_port }} describe --status"
  register: kafka_verify_quorum_status
  retries: "{{ kafka_verify_retries }}"
  delay: "{{ kafka_verify_delay_seconds }}"
  until: kafka_verify_quorum_status.rc == 0
  when: kafka_verify_check_quorum | bool

- name: Show quorum status output
  ansible.builtin.debug:
    var: kafka_verify_quorum_status.stdout_lines
  when: kafka_verify_check_quorum | bool
