---
# Configure Kafka KRaft completely
# Requires inventory to define ansible_host for every broker.

- name: Assert ansible_host is defined for this broker
  ansible.builtin.assert:
    that:
      - ansible_host is defined
      - (ansible_host | string | length) > 0
    fail_msg: "ansible_host is missing for {{ inventory_hostname }}. Set ansible_host in inventories/hosts.yml to a real resolvable hostname/IP."

- name: Compute node.id
  ansible.builtin.set_fact:
    kafka_node_id: "{{ (ansible_play_hosts | list).index(inventory_hostname) + 1 }}"

- name: Set advertise host (must be resolvable)
  ansible.builtin.set_fact:
    kafka_advertise_host: "{{ ansible_host }}"

- name: Assert ansible_host is defined for every broker
  ansible.builtin.assert:
    that:
      - hostvars[item].ansible_host is defined
      - (hostvars[item].ansible_host | string | length) > 0
    fail_msg: "ansible_host is missing for {{ item }}. Set ansible_host in inventories/hosts.yml for every broker."
  loop: "{{ ansible_play_hosts }}"
  run_once: true

- name: Build controller.quorum.voters (using ansible_host only)
  ansible.builtin.set_fact:
    kafka_controller_quorum_voters_str: >-
      {%- set out = [] -%}
      {%- for h in ansible_play_hosts -%}
      {%- set nid = (ansible_play_hosts | list).index(h) + 1 -%}
      {%- set host = hostvars[h].ansible_host -%}
      {%- set _ = out.append(nid ~ '@' ~ host ~ ':' ~ (kafka_controller_port | int)) -%}
      {%- endfor -%}
      {{ out | join(',') }}

- name: Ensure kraft config dir exists
  ansible.builtin.file:
    path: "{{ kafka_install_dir }}/config/kraft"
    state: directory
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0755"

- name: Render server.properties
  ansible.builtin.template:
    src: server.properties.j2
    dest: "{{ kafka_install_dir }}/config/kraft/server.properties"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0644"
  notify: Restart Kafka

# SYSTEMD CLEANUP

- name: Stop Kafka if exists
  ansible.builtin.systemd:
    name: kafka
    state: stopped
  failed_when: false

- name: Remove old systemd units
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/systemd/system/kafka.service
    - /lib/systemd/system/kafka.service
    - /usr/lib/systemd/system/kafka.service
  notify: Daemon reload systemd

- name: Remove drop-in directory
  ansible.builtin.file:
    path: /etc/systemd/system/kafka.service.d
    state: absent
  notify: Daemon reload systemd

- name: Install kafka.service
  ansible.builtin.template:
    src: kafka.service.j2
    dest: /etc/systemd/system/kafka.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Daemon reload systemd
    - Restart Kafka

- name: Reload daemon
  ansible.builtin.systemd:
    daemon_reload: true

# STORAGE (log.dirs)

- name: Read log.dirs
  ansible.builtin.shell: "grep -E '^log.dirs=' {{ kafka_install_dir }}/config/kraft/server.properties | cut -d= -f2-"
  args:
    executable: /bin/bash
  register: kafka_log_dirs_line
  changed_when: false

- name: Set first log dir
  ansible.builtin.set_fact:
    kafka_first_log_dir: "{{ (kafka_log_dirs_line.stdout.split(',')[0]).strip() }}"

- name: Ensure log.dirs directory exists
  ansible.builtin.file:
    path: "{{ kafka_first_log_dir }}"
    state: directory
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0755"

- name: Check meta.properties
  ansible.builtin.stat:
    path: "{{ kafka_first_log_dir }}/meta.properties"
  register: kafka_meta_props

- name: Format KRaft storage if missing
  ansible.builtin.command: >-
    {{ kafka_install_dir }}/bin/kafka-storage.sh format
    -t {{ kafka_cluster_id_effective }}
    -c {{ kafka_install_dir }}/config/kraft/server.properties
  become_user: "{{ kafka_user }}"
  when: not kafka_meta_props.stat.exists

- name: Enable & start Kafka
  ansible.builtin.systemd:
    name: kafka
    enabled: true
    state: started
