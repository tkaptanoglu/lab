---
- name: Ensure cron is installed (Ubuntu/Debian)
  ansible.builtin.apt:
    name: cron
    state: present
    update_cache: false

- name: Ensure cron service is enabled and running
  ansible.builtin.service:
    name: cron
    state: started
    enabled: true

- name: Ensure log file exists
  ansible.builtin.file:
    path: "{{ auto_apt_upgrade_log_file }}"
    state: touch
    owner: root
    group: root
    mode: "0644"

- name: Create daily automated APT upgrade cron job (root crontab)
  ansible.builtin.cron:
    name: "Daily automated APT upgrade"
    user: root
    minute: "{{ auto_apt_upgrade_minute }}"
    hour: "{{ auto_apt_upgrade_hour }}"
    job: >-
      /usr/bin/apt update &&
      /usr/bin/apt upgrade -y >>
      {{ auto_apt_upgrade_log_file }} 2>&1
      {% if auto_apt_upgrade_enable_reboot | bool %}
      && /usr/bin/test -f /var/run/reboot-required && /sbin/reboot
      {% endif %}

